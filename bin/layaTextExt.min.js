var layaTextExt;(function(t){class e{static getClassId(t){let e=this;let i=t.hasOwnProperty(e._CLASS_ID_SIGN);if(!i){e._CLASS_DIC[e._CLASS_ID]=t;Object.defineProperty(t,e._CLASS_ID_SIGN,{value:"CLS_"+e._CLASS_ID++,enumerable:false,writable:false})}return t[e._CLASS_ID_SIGN]}static getClassIdByInstance(t){return this.getClassId(t.constructor)}static regClassId(t,e){let i=this;i._CLASS_DIC[e]=t;Object.defineProperty(t,i._CLASS_ID_SIGN,{value:e,enumerable:false,writable:false})}static getClassById(t){return this._CLASS_DIC[t]}}e._CLASS_ID_SIGN="__classid";e._CLASS_ID=0;e._CLASS_DIC={};t.ClassUtil=e})(layaTextExt||(layaTextExt={}));var layaTextExt;(function(t){class e{constructor(){this.rec=new Laya.Rectangle;this.onPool()}onPool(){this.rec.reset();this.href=null;return this}}t.HTMLHitRect=e})(layaTextExt||(layaTextExt={}));var layaTextExt;(function(t){class e{static parser(s){let h=this;s=s.replace(/\n\r?/gi,"<br/>");h._htmlStackArray.length=0;let t=0;let e=s.length;let a={htmlStyle:[],text:""};while(t<e){let l=s.indexOf("<",t);if(l<0){h.addHtmlText(s.substring(t),a);t=e}else{if(t!=l)h.addHtmlText(s.substring(t,l),a);let i=s.indexOf(">",l);if(i==-1){console.error("文本没有找到结束标签： "+s);i=l}else if(s.charAt(l+1)=="/"){h._htmlStackArray.pop()}else{let t=s.substring(l+1,i).trim();let e=h.addHtmlTag(t,a);if(e.tag&&t.charAt(t.length-1)=="/"){h.addHtmlText("",a);h._htmlStackArray.pop()}}t=i+1}}return a}static addHtmlText(t,e){let i=this;if(i._htmlStackArray.length>0){e.text+=t;e.htmlStyle.push({text:t,style:i._htmlStackArray[i._htmlStackArray.length-1]})}else{e.htmlStyle.push({text:t})}}static addHtmlTag(t,e){let i=this;let l=i.htmlTag2Style(t,e);if(i._htmlStackArray.length==0){i._htmlStackArray.push(l)}else{let e=i._htmlStackArray[i._htmlStackArray.length-1];for(let t in e){if(l[t]==null){l[t]=e[t]}}i._htmlStackArray.push(l)}return l}static htmlTag2Style(l,t){l=l.trim();let s=this;let h={tag:null};let e;let a=0;if(l.match(/^(br)[\/\\]?/gi)){s.addHtmlText("\n",t)}else if(e=l.match(s._htmlTagReg)){l=l.substring(e[0].length);h.tag=e[0].trim();if(h.tag=="i"||h.tag=="u"||h.tag=="b"){s.addHtmlStyleAttr(h,h.tag,"true")}let i;while(i=l.match(s._htmlTagPropReg)){let t=i[1];let e="";l=l.substring(i[0].length).trim();if(l.charAt(0)=='"'){a=l.indexOf('"',1);e=l.substring(1,a);a+=1}else if(l.charAt(0)=="'"){a=l.indexOf("'",1);e=l.substring(1,a);a+=1}else{e=l.match(/(\S)+/)[0];a+=e.length}s.addHtmlStyleAttr(h,t,e);l=l.substring(a).trim()}}return h}static addHtmlStyleAttr(t,e,i){switch(e){case"color":t.color=i;break;case"stroke":t.stroke=+i;break;case"strokeColor":t.strokeColor=i;break;case"width":t.width=+i;break;case"height":t.height=+i;break;case"align":t.align=i;break;case"valign":t.valign=i;break;case"font":t.font=i;break;case"size":t.size=+i;break;case"i":case"italic":t.italic=i=="true";break;case"b":case"bold":t.bold=i=="true";break;case"u":t.underline=i=="true";break;case"underlineColor":t.underlineColor=i;break;default:t[e]=i;break}}}e._htmlStackArray=[];e._htmlTagPropReg=/^(\w+)\s*=/;e._htmlTagReg=/^(font|a|img|image|b|i|u)(\s|$)/;t.HtmlTextParser=e})(layaTextExt||(layaTextExt={}));var layaTextExt;(function(l){l.POOLS={};function t(t){let e=l.ClassUtil.getClassId(t);let i=l.POOLS[e];if(i&&i.length>0){return i.shift()}return new t}l.PoolGet=t;function e(t){if(!t)return;let e=l.ClassUtil.getClassId(t.constructor);let i=l.POOLS[e];if(!i)i=l.POOLS[e]=[];if(i.indexOf(t)<0){if(t.onPool)t.onPool();i.push(t)}}l.PoolPush=e})(layaTextExt||(layaTextExt={}));var layaTextExt;(function(D){class t{static extend(){let W="__textImageContent";let t="__textLineHeights";let i="__htmlHitList";let B="1";let O=/^(\d|\.|\+|\-|[a-z]| )+$/gi;let e=Laya.TextStyle.prototype;let l=e.reset;Object.defineProperties(e,{reset:{value:function(){this.htmlStyle=undefined;return l.call(this)}}});let s=Laya.Text.prototype;let h=s.set_text;let a=s.destroy;Object.defineProperties(s,{destroy:{value:function(t=true){this.clearHtml();a.call(this,t)},enumerable:true},clearHtml:{value:function(){if(this[W]){this.removeImageContent();this[W].removeSelf();this[W]=null}this.off(Laya.Event.CLICK,this,this._handleClickText);this[t]=null;if(this[i]){let e=this[i];for(let t=0;t<e.length;t++){D.PoolPush(e[t])}e.length=0;this[i]=null}},enumerable:false},htmlText:{set(e){{this._htmlText=e;this.clearHtml();let t=D.HtmlTextParser.parser(e);this._getTextStyle().htmlStyle=t.htmlStyle;this._text=t.text;this.lang(e+"");this.isChanged=true;this.event(Laya.Event.CHANGE);if(this.borderColor){this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1)}}},get(){return this._htmlText},enumerable:true},set_text:{value:function(t){this._htmlText=null;this._getTextStyle().htmlStyle=null;this.clearHtml();h.call(this,t)},enumerable:true},_lineHeights:{get:function(){if(!this[t])this[t]=[];return this[t]},enumerable:true},_htmlHitList:{get:function(){if(!this[i])this[i]=[];return this[i]},enumerable:true},removeImageContent:{value:function(){let i=this[W];if(i){for(let e=i.numChildren-1;e>=0;e--){let t=i.getChildAt(e);D.PoolPush(t)}}},enumerable:true},_renderText:{value:function(){this.removeImageContent();var S=this.padding;var t=this._lines.length;if(this.overflow!=Laya.Text.VISIBLE){t=Math.min(t,Math.floor((this.height-S[0]-S[2])/(this.leading+this._charSize.height))+1)}var v=this.scrollY/(this._charSize.height+this.leading)|0;var p=this.graphics;p.clear(true);var T=this._getContextFont();Laya.Browser.context.font=T;var e=S[3];var w="left";var i=this._lines;var l=this.leading+this._charSize.height;var C=this._style;var s=this._style.currBitmapFont;if(s){l=this.leading+s.getMaxHeight()}var h=S[0];if(!s&&this._width>0&&this._textWidth<=this._width){if(this.align=="right"){w="right";e=this._width-S[1]}else if(this.align=="center"){w="center";e=this._width*.5+S[3]-S[1]}}let a=1;if(s&&s.autoScaleSize){a=s.fontSize/this.fontSize}if(this._height>0){var r=this._textHeight>this._height?"top":this.valign;if(r==="middle")h=(this._height-t/a*l)*.5+S[0]-S[2];else if(r==="bottom")h=this._height-t/a*l-S[2]}if(this._clipPoint){p.save();if(s&&s.autoScaleSize){var n;var o;this._width?n=this._width-S[3]-S[1]:n=this._textWidth;this._height?o=this._height-S[0]-S[2]:o=this._textHeight;n*=a;o*=a;p.clipRect(S[3],S[0],n,o)}else{p.clipRect(S[3],S[0],this._width?this._width-S[3]-S[1]:this._textWidth,this._height?this._height-S[0]-S[2]:this._textHeight)}this.repaint()}var b=C.asPassword;if("prompt"in this&&this["prompt"]==this._text)b=false;var L=0,k=0;var f=Math.min(this._lines.length,t+v)||1;if(this[W]){this[W].removeChildren()}if(C.htmlStyle){let _=0;let u=0;let y=0;let x=T;let m=false;if(this._height>0){var r=this._textHeight>this._height?"top":this.valign;if(r==="middle")h=(this._height-this._textHeight)*.5+S[0]-S[2];else if(r==="bottom")h=this._height-this._textHeight-S[2]}k=h-(this._clipPoint?this._clipPoint.y:0);for(var H=0;H<C.htmlStyle.length;H++){let i=C.htmlStyle[H];var I=i.text;let t=T;if(i.style){if(i.style.font||i.style.size||i.style.italic||i.style.bold){t=this._getContextFontCustom({font:i.style.font,fontSize:i.style.size,italic:i.style.italic,bold:i.style.bold})}}if(x!=t){x=t;Laya.Browser.context.font=x}let l=this._getTextWidth(I);let s=l;var z;if(b){let t=I.length;I="";for(var P=t;P>0;P--){I+="●"}}if(I==null)I="";if(H==0||I=="\n"){if(I=="\n"){k+=u+this.leading;y++;if(this.overflow==Laya.Text.HIDDEN){if(this.height&&k>=this.height){return}}}L=S[3]-(this._clipPoint?this._clipPoint.x:0);let t=this._lineWidths[y];u=this._lineHeights[y];if(w=="center"){L=this._width*.5+S[3]-S[1]-t*.5}else if(w=="right"){L=this._width-S[1]-t}}if(I=="\n"){continue}let h=this.color;let e=C.stroke;let a=C.strokeColor;let r="left";let n=l;let o=this._charSize.height;let f=this.valign;let g=this.underline;let d=this.underlineColor;let c;_=0;if(i.style){if(i.style.color)h=i.style.color;if(i.style.stroke)e=i.style.stroke;if(i.style.valign)f=i.style.valign;if(i.style.size)o=i.style.size;if(i.style.height)o=i.style.height;if(i.style.underline)g=i.style.underline;if(i.style.underlineColor)d=i.style.underlineColor;if(i.style.strokeColor)a=i.style.strokeColor;if(i.style.width){l=i.style.width;n=l}if(i.style.tag=="image"||i.style.tag=="img"){if(!l){l=this.fontSize;n=l}}if(i.style.align){r=i.style.align;let t=0;let e=i.style.width;if(!e){if(H+1<C.htmlStyle.length){if(C.htmlStyle[H+1].text=="\n"){e=this._textWidth-L}}}if(e){if(e>s){if(r=="right"){t=L+e;if(L<t)L=t;n=0}else if(r=="center"){t=L+e*.5;if(L<t)L=t;n=e*.5}}}else{if(r=="right"){L=L+l;n=0}else if(r=="center"){n=l/2;L=L+l/2}}}if(i.style.tag=="image"||i.style.tag=="img"){if(!this[W]){this[W]=new Laya.Sprite;this.addChild(this[W])}let t=D.PoolGet(D.TextImage);t.skin=i.style.src;c=t;this[W].addChild(c)}if(i.style.tag=="a"){m=true;var A=D.PoolGet(D.HTMLHitRect);A.rec.setTo(L,k,l,o);A.href=i.style?i.style.href:null;this._htmlHitList.push(A)}}if(u>o+this.leading){let t=o;O.lastIndex=-1;if(O.test(i.text)){var E=null;if(Laya.Render.isConchApp){E=window.conchTextCanvas.measureText(B)}else{E=Laya.Browser.context.measureText(B)}if(E){t=E.height||E.actualBoundingBoxAscent||this.fontSize}}if(f=="bottom"){_=u-t}else if(f=="middle"){_=(u-t)/2}else{_=0}}if(c){c.width=l;c.height=o;c.x=L;c.y=k+_}if(g){let t=L;let e=k;switch(r){case"center":t-=l/2;break;case"right":t-=l;break;case"left":default:break}e+=this._charSize.height+_;this._graphics.drawLine(t,e,t+l,e,d||h,1)}this._words||(this._words=[]);if(this._words.length>H-v){z=this._words[H-v]}else{z=new Laya.WordText;this._words.push(z)}z.setText(I);z.splitRender=this._singleCharRender;e?p.fillBorderText(z,L,k+_,x,h,r,e,a):p.fillText(z,L,k+_,x,h,r);L+=n}if(m){this.on(Laya.Event.CLICK,this,this._handleClickText)}}else{for(var H=v;H<f;H++){var g=i[H];var z;if(b){let t=g.length;g="";for(var P=t;P>0;P--){g+="●"}}if(g==null)g="";L=e-(this._clipPoint?this._clipPoint.x:0);k=h+l*H-(this._clipPoint?this._clipPoint.y:0);this.underline&&this._drawUnderline(w,L,k,H);if(s){var d=this.width;if(s.autoScaleSize){d=this.width*a;L*=a;k*=a}s["_drawText"](g,this,L,k,this.align,d)}else{this._words||(this._words=[]);if(this._words.length>H-v){z=this._words[H-v]}else{z=new Laya.WordText;this._words.push(z)}z.setText(g);z.splitRender=this._singleCharRender;C.stroke?p.fillBorderText(z,L,k,T,this.color,w,C.stroke,C.strokeColor):p.fillText(z,L,k,T,this.color,w)}}}if(s&&s.autoScaleSize){var c=1/a;this.scale(c,c)}if(this._clipPoint)p.restore();this._startX=e;this._startY=h},enumerable:true,writable:true},_getContextFontCustom:{value:function(t){let e=t.italic!=undefined?t.italic:this.italic;let i=t.bold!=undefined?t.bold:this.bold;let l=t.fontSize!=undefined?t.fontSize:this.fontSize;let s=t.font!=undefined?t.font:this.font;return(e?"italic ":"")+(i?"bold ":"")+l+"px "+(Laya.Browser.onIPhone?Laya.Text.fontFamilyMap[s]||s:s)},enumerable:false},_handleClickText:{value:function(){var t=this.mouseX;var e=this.mouseY;var i,l;var s;l=this._htmlHitList.length;for(i=0;i<l;i++){s=this._htmlHitList[i];if(s.rec.contains(t,e)){this.event(Laya.Event.LINK,[s.href])}}}},_evalTextSize:{value:function(){var t=this._style;var e,i;e=Math.max.apply(this,this._lineWidths);let l=this._style.currBitmapFont;if(l){let t=l.getMaxHeight();if(l.autoScaleSize){t=this.fontSize}i=this._lines.length*(t+this.leading)+this.padding[0]+this.padding[2]}else if(t.htmlStyle){let e=this._lineHeights;i=this.padding[0]+this.padding[2];for(let t=0;t<e.length;t++){i+=e[t]+this.leading}if(e.length){i-=this.leading}}else{i=this._lines.length*(this._charSize.height+this.leading)+this.padding[0]+this.padding[2];if(this._lines.length){i-=this.leading}}if(e!=this._textWidth||i!=this._textHeight){this._textWidth=e;this._textHeight=i}},enumerable:true},_parseLines:{value:function(t){var e=this.wordWrap||this.overflow==Laya.Text.HIDDEN;if(e){var s=this._getWordWrapWidth()}var i=this._style.currBitmapFont;if(i){this._charSize.width=i.getMaxWidth();this._charSize.height=i.getMaxHeight()}else{var l=null;if(Laya.Render.isConchApp){l=window.conchTextCanvas.measureText(Laya.Text["_testWord"])}else{l=Laya.Browser.context.measureText(Laya.Text["_testWord"])}if(!l)l={width:100};this._charSize.width=l.width;this._charSize.height=l.height||this.fontSize}var h=this._style;if(h.htmlStyle){let i=0;let l=0;if(!e){s=1e6}this._lineHeights.length=0;for(var a=0;a<h.htmlStyle.length;a++){let t=h.htmlStyle[a];if(t.text!="\n"){l=a;if(a!=h.htmlStyle.length-1)continue}let e=this._parseStyleLine(s,i,l);a=a+e;i=a+1}}else{var r=t.replace(/\r\n/g,"\n").split("\n");for(var a=0,n=r.length;a<n;a++){var o=r[a];if(e)this._parseLine(o,s);else{this._lineWidths.push(this._getTextWidth(o));this._lines.push(o)}}}},enumerable:true,writable:true},_parseStyleLine:{value:function(n,t,s){let o=0;let h=0;var f=this._style;if(!f.htmlStyle)return h;let g=0;let d="";var a=this._getContextFont();let c=Laya.Browser.context.font;var _=this._charSize.height;let u=_;for(var y=t;y<=s;y++){let r=f.htmlStyle[y];let t=a;let e=_;if(r.style){if(r.style.font||r.style.size||r.style.italic||r.style.bold){t=this._getContextFontCustom({font:r.style.font,fontSize:r.style.size,italic:r.style.italic,bold:r.style.bold})}if(r.style.height){e=r.style.height}else if(r.style.size){e=r.style.size}}if(c!=t){c=t;Laya.Browser.context.font=c}let i=r.style&&r.style.width!=undefined;let l=i?r.style.width:this._getTextWidth(r.text);if(g+l<=n){if(e>u)u=e;g+=l;d+=r.text;continue}if(i){this._lines.push(d);this._lineWidths.push(g);this._lineHeights.push(u);f.htmlStyle.splice(y,0,{text:"\n"});o=1;g=l;d=r.text;u=e}else{if(e>u)u=e;let i=r.text;let l=[];let s={text:"",style:r.style};let h=0;let a;while(h<i.length){let t=Math.floor((n-g)/this._charSize.width);if(t>0){a=i.substring(h,h+t);g=g+this._getTextWidth(a);s.text+=a;d+=a;h=h+t}a=i.charAt(h);let e=this._getTextWidth(a);if(g+e>n){l.push(s);l.push({text:"\n"});this._lines.push(d);this._lineWidths.push(g);this._lineHeights.push(u);s={text:"",style:r.style};g=0;d=""}else{s.text+=a;d+=a;h=h+1;g+=e}}l.push(s);f.htmlStyle.splice(y,1,...l);o=l.length-1}s+=o;y+=o;h+=o}if(d||g>0||u>0){this._lines.push(d);this._lineWidths.push(g);this._lineHeights.push(u);d="";g=0;u=0}return h},enumerable:true,writable:true}})}}D.TextExtends=t})(layaTextExt||(layaTextExt={}));var layaTextExt;(function(t){class e extends Laya.Image{onPool(){let t=this;t.x=0;t.y=0;t.skin=null;t.scaleX=t.scaleY=1;t.width=undefined;t.height=undefined}}t.TextImage=e})(layaTextExt||(layaTextExt={}));